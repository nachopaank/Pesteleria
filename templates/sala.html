<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sala {{ codigo }} - Pestelería</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<style>
body { font-family:sans-serif; margin:0; padding:0; background:#f4f4f4; }
.container { max-width:600px; margin:auto; padding:10px; background:#fff; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
h1,h3 { text-align:center; }
ul { list-style:none; padding:0; margin:0 0 20px 0; max-height:250px; overflow-y:auto; border:1px solid #ddd; background:#fff; border-radius:8px; }
li { padding:8px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eee; position:relative; }
li:last-child { border-bottom:none; }
li img { width:70px; height:70px; border-radius:50%; margin-right:10px; transition:all 0.3s ease; object-fit:cover; }
.verde { color:green; font-weight:bold; }
.amarillo { color:orange; font-weight:bold; }
.rojo { color:red; font-weight:bold; }
button { padding:8px 12px; margin-left:5px; border:none; border-radius:5px; font-size:16px; cursor:pointer; }
button:hover { opacity:0.9; }
#votacion button { display:block; width:100%; margin:5px 0; }
input[type="number"] { width:60px; padding:6px; margin-right:5px; border-radius:5px; border:1px solid #ccc; }
.cruz { position:absolute; top:0; left:0; background:red; color:white; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; }
@media(max-width:600px){body{padding:5px;} button{font-size:18px; padding:10px;} li img{width:60px; height:60px;}}
</style>
</head>
<body>
<div class="container">
<h1>Sala {{ codigo }} - Pestelería</h1>
<p>Bienvenido, <b>{{ nombre }}</b> {% if es_host %}(HOST){% endif %}</p>

<h3>Jugadores:</h3>
<ul id="jugadores"></ul>

{% if es_host %}
<button id="asignarBtn">Descartar roles</button>
<h3>Roles no descartados:</h3>
<ul id="roles_no_descartados"></ul>

<div>
<input type="number" id="tiempo" placeholder="Tiempo en segundos">
<button id="startHoguera">Iniciar hoguera</button>
</div>
{% endif %}

<h3>Roles descartados:</h3>
<ul id="descartados"></ul>

<h3>Votación:</h3>
<div id="votacion"></div>
</div>

<script>
const socket = io();
const codigo = "{{ codigo }}";
const nombre = "{{ nombre }}";
const es_host = {{ es_host|tojson }};
let jugadores_estado = {};
let partidasFotos = {};
let roles_no_descartados = [];

socket.emit("join",{codigo,nombre});

socket.on("jugadores",(data)=>{
  jugadores_estado=data.jugadores;
  partidasFotos=data.fotos;
  const ul=document.getElementById("jugadores");
  ul.innerHTML="";
  for(let j in jugadores_estado){
    const li=document.createElement("li");
    let estado=jugadores_estado[j];
    li.className = estado==="activo"?"verde":estado==="inactivo"?"amarillo":"rojo";

    const cont=document.createElement("div");
    cont.style.position="relative";
    const img=document.createElement("img");
    img.src = partidasFotos[j] || "/static/icon.png";
    if(estado==="muerto") img.style.opacity="0.6";
    cont.appendChild(img);

    if(estado==="muerto"){
      const cruz=document.createElement("div");
      cruz.className="cruz";
      cruz.textContent="X";
      cont.appendChild(cruz);
    }

    li.appendChild(cont);
    li.appendChild(document.createTextNode(j + (estado==="inactivo"?" (inactivo)":"")));

    if(es_host && estado!=="muerto"){
      const btn=document.createElement("button");
      btn.textContent="💀 Matar";
      btn.onclick=()=>{socket.emit("matar_jugador",{codigo,jugador:j,host:nombre});};
      li.appendChild(btn);
    }
    ul.appendChild(li);
  }
});

// -----------------------------------
// Descartar roles
// -----------------------------------
document.getElementById("asignarBtn")?.addEventListener("click",()=>{
  socket.emit("asignar_roles",{codigo,nombre});
});

socket.on("roles_descartados",(descartados)=>{
  const ul=document.getElementById("descartados");
  ul.innerHTML="";
  descartados.forEach(r=>{
    const li=document.createElement("li");
    li.textContent=r;
    ul.appendChild(li);
  });
});

// Mostrar roles no descartados al host
socket.on("roles_no_descartados",(roles)=>{
  roles_no_descartados=roles;
  const ul=document.getElementById("roles_no_descartados");
  ul.innerHTML="";
  roles.forEach(r=>{
    const li=document.createElement("li");
    li.textContent=r;
    ul.appendChild(li);
  });
});

// -----------------------------------
// Hoguera / votación
// -----------------------------------
document.getElementById("startHoguera")?.addEventListener("click",()=>{
  const tiempo=document.getElementById("tiempo").value;
  socket.emit("iniciar_hoguera",{codigo,host:nombre,tiempo});
});

socket.on("votacion_iniciada",(data)=>{
  const div=document.getElementById("votacion");
  div.innerHTML="";
  if(data.tiempo!==null) div.innerHTML=`<p>Votación activa. Tiempo: <span id="tiempo">${data.tiempo}</span> s</p>`;
  if(jugadores_estado[nombre]==="muerto"){div.innerHTML+="<p>No puedes votar, estás muerto.</p>"; return;}
  if(data.ya_voto){div.innerHTML+="<p>Has votado.</p>"; return;}
  data.jugadores.forEach(j=>{
    const btn=document.createElement("button");
    btn.textContent=j;
    btn.onclick=()=>{
      socket.emit("votar",{codigo,votante:nombre,voto:j});
      div.innerHTML="<p>Has votado.</p>";
    };
    div.appendChild(btn);
  });
  const nadie=document.createElement("button");
  nadie.textContent="Nadie";
  nadie.onclick=()=>{
    socket.emit("votar",{codigo,votante:nombre,voto:"Nadie"});
    div.innerHTML="<p>Has votado.</p>";
  };
  div.appendChild(nadie);
});

socket.on("votacion_tick",(tiempo)=>{
  const span=document.getElementById("tiempo");
  if(span) span.textContent=tiempo;
});

socket.on("votacion_finalizada",(resultados)=>{
  const div=document.getElementById("votacion");
  div.innerHTML="<h4>Resultados de la votación:</h4>";
  for(let r in resultados){
    const p=document.createElement("p");
    p.textContent=`${r}: ${resultados[r]} votos`;
    div.appendChild(p);
  }
});

// -----------------------------------
// Status de jugador
// -----------------------------------
if(!es_host){
  document.addEventListener("visibilitychange",()=>{socket.emit("set_status",{codigo,nombre,status:!document.hidden});});
  socket.emit("set_status",{codigo,nombre,status:true});
}
</script>
</body>
</html>
