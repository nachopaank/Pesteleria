<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sala {{ codigo }} - Pesteler√≠a</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:sans-serif; margin:0; padding:0; background:#f4f4f4; }
.container { max-width:800px; margin:auto; padding:10px; background:#fff; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
h1,h4 { text-align:center; }
select, button { padding:6px 10px; margin:5px; border-radius:5px; border:1px solid #ccc; font-size:14px; }
button { cursor:pointer; }
.grid {
  display: grid;
  gap: 15px;
  justify-content: center;
  margin-bottom: 20px;
}
.grid-item {
  text-align: center;
  position: relative;
}
.grid-item img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid transparent;
  transition: all 0.3s ease;
}
.grid-item .cruz {
  position: absolute;
  top: 0;
  left: 0;
  background:red;
  color:white;
  width:24px;
  height:24px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:16px;
}
.grid-item span {
  display: block;
  margin-top: 5px;
  font-weight: bold;
}
#hoguera_controls { margin-top:20px; text-align:center; display:none; }
#votos { margin-bottom:10px; font-weight:bold; }
</style>
</head>
<body>
<div class="container">
<h1>Sala {{ codigo }} - Pesteler√≠a</h1>
<p>Bienvenido, <b>{{ nombre }}</b> {% if es_host %}(HOST){% endif %}</p>

{% if es_host %}
<div id="hoguera_host_ui" style="margin-bottom:20px;">
  <h4>Iniciar Hoguera</h4>
  <select id="jugador1_select"></select>
  <select id="jugador2_select"></select>
  <button id="btn_iniciar_hoguera">Iniciar Hoguera</button>
</div>
{% endif %}

<div id="jugadores_grid" class="grid"></div>

<div id="hoguera_controls">
  <h4>Hoguera:</h4>
  <div id="votos"></div>
  <div id="host_controls"></div>
</div>

</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
const codigo = "{{ codigo }}";
const nombre = "{{ nombre }}";
const es_host = {{ es_host|tojson }};

let jugadores_estado = {};
let partidasFotos = {};
let votacion = null;

// Captura de foto al cargar la sala
window.addEventListener("load", async ()=>{
  const video = document.createElement("video");
  const canvas = document.createElement("canvas");
  let fotoData = "/static/icon.png";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    await video.play();
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    fotoData = canvas.toDataURL("image/png");
  } catch(err){
    console.log("No se pudo acceder a la c√°mara, se usar√° icon.png");
  }

  socket.emit("unirse_con_foto", {codigo, nombre, foto: fotoData});
});

// Funciones para grid y selects
function actualizarSelects(){
  if(!es_host) return;
  const sel1 = document.getElementById("jugador1_select");
  const sel2 = document.getElementById("jugador2_select");

  sel1.innerHTML = '';
  sel2.innerHTML = '';

  for(let j in jugadores_estado){
    if(jugadores_estado[j]!=="muerto" && j!=="HOST"){
      sel1.innerHTML += `<option value="${j}">${j}</option>`;
      sel2.innerHTML += `<option value="${j}">${j}</option>`;
    }
  }
}

function actualizarGrid(){
  const container = document.getElementById("jugadores_grid");
  container.innerHTML = "";

  const total = Object.keys(jugadores_estado).filter(j=>j!=="HOST").length;
  let columnas = 3;
  if(total>9) columnas = 5;
  else if(total>6) columnas = 4;
  container.style.gridTemplateColumns = `repeat(${columnas}, auto)`;

  for(let j in jugadores_estado){
    if(j==="HOST") continue;
    const estado = jugadores_estado[j];
    const div = document.createElement("div");
    div.className = "grid-item";

    const img = document.createElement("img");
    img.src = partidasFotos[j] || "/static/icon.png";

    if(estado==="activo"){ img.style.borderColor="green"; img.style.filter="none"; }
    else if(estado==="inactivo"){ img.style.borderColor="orange"; img.style.filter="none"; }
    else if(estado==="muerto"){ img.style.borderColor="red"; img.style.filter="grayscale(100%)"; 
      const cruz = document.createElement("div"); cruz.className="cruz"; cruz.textContent="X"; div.appendChild(cruz); }

    div.appendChild(img);
    const span = document.createElement("span"); span.textContent=j; div.appendChild(span);

    if(es_host && estado!=="muerto"){
      const btn = document.createElement("button");
      btn.textContent="üíÄ Matar";
      btn.onclick = ()=>socket.emit("matar_jugador",{codigo,jugador:j});
      div.appendChild(btn);
    }

    container.appendChild(div);
  }
}

// -----------------------------------
// SOCKETS
// -----------------------------------
socket.on("jugadores",(data)=>{
  jugadores_estado=data.jugadores;
  partidasFotos=data.fotos;
  actualizarGrid();
  actualizarSelects();
});

socket.on("votacion_iniciada",(data)=>{
  votacion = data;
  document.getElementById("hoguera_controls").style.display="block";
  actualizarVotos(votacion.votos);
  if(es_host) mostrarBotonesHost();
});

socket.on("votos_actualizados",(votos)=>{
  actualizarVotos(votos);
});

socket.on("votacion_finalizada",(votos)=>{
  actualizarVotos(votos);
  alert("Hoguera finalizada!\nResultado:\n" + votacion.jugadores[0] + ": " + votos[votacion.jugadores[0]] + "\n" + votacion.jugadores[1] + ": " + votos[votacion.jugadores[1]] + "\nNadie: " + votos["Nadie"]);
  document.getElementById("host_controls").innerHTML="";
  votacion=null;
});

// -----------------------------------
// Hoguera
// -----------------------------------
function actualizarVotos(votos){
  const div = document.getElementById("votos");
  if(votacion){
    div.innerHTML = votacion.jugadores.map(j=>j + ": " + votos[j]).join("<br>") + "<br>Nadie: " + votos["Nadie"];
  }
}

function mostrarBotonesHost(){
  const div = document.getElementById("host_controls");
  div.innerHTML = "";
  votacion.jugadores.forEach(j=>{
    const btnSum = document.createElement("button");
    btnSum.textContent = "+ " + j;
    btnSum.onclick = ()=>socket.emit("modificar_voto",{codigo, jugador:j, accion:"sumar", host:nombre});
    const btnRest = document.createElement("button");
    btnRest.textContent = "- " + j;
    btnRest.onclick = ()=>socket.emit("modificar_voto",{codigo, jugador:j, accion:"restar", host:nombre});
    div.appendChild(btnSum);
    div.appendChild(btnRest);
  });

  const btnNadie = document.createElement("button");
  btnNadie.textContent = "+ Nadie";
  btnNadie.onclick = ()=>socket.emit("modificar_voto",{codigo,jugador:"Nadie",accion:"sumar",host:nombre});
  div.appendChild(btnNadie);

  const btnFinal = document.createElement("button");
  btnFinal.textContent="Finalizar Hoguera";
  btnFinal.onclick = ()=>socket.emit("finalizar_hoguera",{codigo, host:nombre});
  div.appendChild(btnFinal);
}

// Iniciar hoguera host
if(es_host){
  document.getElementById("btn_iniciar_hoguera").onclick=()=>{
    const j1=document.getElementById("jugador1_select").value;
    const j2=document.getElementById("jugador2_select").value;
    if(j1===j2){
      alert("Debes escoger dos jugadores distintos");
      return;
    }
    socket.emit("iniciar_hoguera",{codigo, jugador1:j1, jugador2:j2, host:nombre});
  }
}

// -----------------------------------
// Status de jugador
// -----------------------------------
if(!es_host){
  document.addEventListener("visibilitychange",()=>{socket.emit("set_status",{codigo,nombre,status:!document.hidden});});
  socket.emit("set_status",{codigo,nombre,status:true});
}
</script>
</body>
</html>
