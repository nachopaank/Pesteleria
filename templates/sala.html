<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sala {{ codigo }} - Pesteler√≠a</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Reset b√°sico */
body, html { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); color:#333; }

/* Contenedor principal */
.container { max-width:900px; margin:auto; padding:20px; background: rgba(255,255,255,0.95); border-radius:20px; box-shadow:0 8px 20px rgba(0,0,0,0.2); }

/* Titulos */
h1,h4 { text-align:center; color:#222; }
h1 { font-size:2rem; margin-bottom:5px; }
h4 { font-size:1.2rem; margin-top:20px; margin-bottom:10px; }

/* Botones y selects */
select, button { padding:8px 12px; margin:5px; border-radius:8px; border:1px solid #ccc; font-size:14px; font-weight:bold; cursor:pointer; transition:0.2s; }
button:hover { background:#2196F3; color:#fff; border:none; }

/* Grid de jugadores */
.grid {
  display: grid;
  gap: 20px;
  justify-content: center;
  margin-bottom: 20px;
}
@media (max-width: 600px) {
  .grid { grid-template-columns: repeat(3, 1fr); }
}
@media (min-width: 601px) and (max-width: 900px) {
  .grid { grid-template-columns: repeat(4, 1fr); }
}
@media (min-width: 901px) {
  .grid { grid-template-columns: repeat(5, 1fr); }
}

.grid-item {
  text-align: center;
  position: relative;
  background: #f9f9f9;
  padding:10px;
  border-radius:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
.grid-item:hover { transform: translateY(-5px); }

.grid-item img.jugador-foto {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid transparent;
  transition: all 0.3s ease;
  display: block;
}

.grid-item .calavera {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: url('/static/skull.png') no-repeat center center;
  background-size: contain;
  pointer-events: none;
  z-index: 3;
  transform: translate(-50%, -50%);
}

.grid-item span {
  display: block;
  margin-top: 8px;
  font-weight: bold;
  font-size: 1rem;
}

/* Controles de hoguera */
#hoguera_controls { margin-top:20px; text-align:center; display:none; }
#votos { margin-bottom:10px; font-weight:bold; font-size:1rem; }

/* Bot√≥n nueva partida */
#btn_nueva_partida {
  display:block;
  margin: 20px auto;
  padding:10px 20px;
  background:#FF6B6B;
  color:white;
  font-weight:bold;
  border:none;
  border-radius:10px;
  box-shadow:0 4px 8px rgba(0,0,0,0.2);
  transition:0.2s;
}
#btn_nueva_partida:hover { background:#FF4C4C; cursor:pointer; }
</style>
</head>
<body>
  <!-- Bot√≥n Reglas arriba a la derecha -->
<button id="btn_reglas" class="btn-reglas">üìú Reglas</button>

<!-- Modal -->
<div id="modal_reglas" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Reglas del Juego</h2>

    <h3 class="verde">üü¢ Roles Verdes</h3>
    <ul>
      <li><b>Monja</b> ‚Äì Proteges a alguien durante la noche. Nunca la misma persona 2 veces seguidas. Puedes protegerte a ti mismo. Lo √∫nico que supera tu protecci√≥n es el amor.</li>
      <li><b>Guerrero</b> ‚Äì Tienes 2 vidas.</li>
      <li><b>Demonio</b> ‚Äì Una vez por partida. Cada noche te despiertas, se te dice qu√© personas han muerto, y puedes elegir convertirte en una de ellas.</li>
      <li><b>Adivina</b> ‚Äì Cada noche se√±alas a alguien y se te muestra su rol.</li>
      <li><b>Bruja</b> ‚Äì Una poci√≥n de vida y una de muerte. √önicas por partida.</li>
      <li><b>Tonto del pueblo</b> ‚Äì Si pierdes al final de una hoguera exclamas "soy tonto" y no mueres.</li>
      <li><b>Vampiro</b> ‚Äì La primera noche eliges una v√≠ctima. Si consigues matarlo en una hoguera, ganas una vida. Cuando esta persona muera (gane o no vida) la siguiente noche escoges nueva v√≠ctima.</li>
    </ul>

    <h3 class="rojo">üî¥ Roles Rojos</h3>
    <ul>
      <li><b>Cazador</b> ‚Äì Al morir disparas a alguien durante el d√≠a.</li>
      <li><b>Asesino</b> ‚Äì Al morir en hoguera apu√±alas inmediatamente a alguien.</li>
      <li><b>Ramera</b> ‚Äì Cada noche te acuestas con alguien, anulando su habilidad nocturna. Nunca la misma persona 2 veces seguidas.</li>
      <li><b>Boticario</b> ‚Äì Drogas a alguien cada noche. Durante el d√≠a solo podr√° hablar con vocales. Repetir solo si incumple la restricci√≥n.</li>
      <li><b>Jacob</b> ‚Äì La primera noche te enamoras. Si tu amor muere, te conviertes en hombre lobo y matar√°s cada noche hasta vengarte.</li>
      <li><b>Celestina</b> ‚Äì Enamoras a 2 personas. Si una muere, la otra muere tambi√©n.</li>
    </ul>

    <h3 class="azul">üîµ Roles Azules</h3>
    <ul>
      <li><b>Doctor peste</b> ‚Äì Envenenas a alguien cada noche.</li>
      <li><b>Hijo del doctor peste</b> ‚Äì Te conviertes en el Doctor si √©ste muere. Si mueres en hoguera, el Doctor envenena 2 veces la siguiente noche.</li>
      <li><b>Doctor de la muerte</b> ‚Äì Envenenas junto a los dem√°s doctores. Ganas si eres el √∫nico Doctor vivo al final.</li>
    </ul>

    <h3>‚öîÔ∏è Mec√°nicas Generales</h3>
    <p>El juego tiene 2 bandos: <b>Pueblo</b> y <b>Doctores</b>.  
    Se reparten los roles aleatoriamente y solo cada uno conoce el suyo.  
    La partida avanza en ciclos: <b>Noche ‚Üí D√≠a ‚Üí Noche</b> hasta que un bando gane.</p>

    <h3>üåô Noche</h3>
    <ul>
      <li>El narrador manda a dormir al pueblo (ojos cerrados).</li>
      <li>Solo abre los ojos el rol llamado por el narrador.</li>
      <li>La comunicaci√≥n es con gestos: pulgar abajo (matar), pulgar arriba (revivir), se√±alar para habilidades.</li>
    </ul>

    <h3>üåû D√≠a</h3>
    <ul>
      <li>El narrador anuncia qui√©n ha muerto.</li>
      <li>El pueblo discute.</li>
      <li>El primer d√≠a se elige un <b>rey</b> por votaci√≥n (desempata en caso de empate).</li>
      <li>Durante el d√≠a puede iniciarse una <b>hoguera</b> (‚Äú[nombre] a la hoguera‚Äù) ‚Üí se vota entre acusado, acusador o en blanco.</li>
      <li>Tambi√©n puede haber una <b>rebeli√≥n</b>: si tiene mayor√≠a se nombra un nuevo rey; si fracasa, el rey decide si ejecuta al rebelde.</li>
    </ul>

    <p><b>Nota:</b> Solo puede haber una hoguera y/o una rebeli√≥n por d√≠a.</p>
  </div>
</div>

<style>
/* Bot√≥n Reglas */
.btn-reglas {
  position: fixed;
  top: 15px;
  right: 15px;
  padding: 10px 15px;
  border: none;
  border-radius: 12px;
  background: #2196F3;
  color: white;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: 0.2s;
  z-index: 1000;
}
.btn-reglas:hover { background: #1769aa; }

/* Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  padding-top: 80px;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.6);
}
.modal-content {
  background: #fff;
  margin: auto;
  padding: 20px;
  border-radius: 20px;
  max-width: 700px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  overflow-y: auto;
  max-height: 80vh;
}
.modal-content h2 {
  text-align:center;
  margin-bottom:15px;
}
.modal-content h3 {
  margin-top:20px;
}
.modal-content ul {
  padding-left: 20px;
}
.close {
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover { color: red; }

/* Colores roles */
.verde { color: green; }
.rojo { color: darkred; }
.azul { color: navy; }
</style>

<script>
const modal = document.getElementById("modal_reglas");
const btn = document.getElementById("btn_reglas");
const span = document.querySelector(".modal .close");

btn.onclick = ()=>{ modal.style.display = "block"; }
span.onclick = ()=>{ modal.style.display = "none"; }
window.onclick = (event)=>{ if(event.target == modal){ modal.style.display = "none"; } }
</script>

<div class="container">
<h1>Sala {{ codigo }} - Pesteler√≠a</h1>
<p style="text-align:center; font-size:1.1rem;">Bienvenido, <b>{{ nombre }}</b> {% if es_host %}(HOST){% endif %}</p>

{% if es_host %}
<div id="hoguera_host_ui" style="margin-bottom:20px;">
  <h4>Iniciar Hoguera</h4>
  <select id="jugador1_select"></select>
  <select id="jugador2_select"></select>
  <button id="btn_iniciar_hoguera">Iniciar Hoguera</button>
</div>

<!-- Bot√≥n Nueva Partida -->
<button id="btn_nueva_partida">Nueva partida</button>
{% endif %}

<div id="jugadores_grid" class="grid"></div>

<div id="hoguera_controls">
  <h4>Hoguera:</h4>
  <div id="votos"></div>
  <div id="host_controls"></div>
</div>

</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
const codigo = "{{ codigo }}";
const nombre = "{{ nombre }}";
const es_host = {{ es_host|tojson }};

let jugadores_estado = {};
let partidasFotos = {};
let votacion = null;

// Captura de foto al cargar la sala
window.addEventListener("load", async ()=>{
  const video = document.createElement("video");
  const canvas = document.createElement("canvas");
  let fotoData = "/static/icon.png";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    await video.play();
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    fotoData = canvas.toDataURL("image/png");
  } catch(err){
    console.log("No se pudo acceder a la c√°mara, se usar√° icon.png");
  }

  socket.emit("unirse_con_foto", {codigo, nombre, foto: fotoData});
});

// Funciones para grid y selects
function actualizarSelects(){
  if(!es_host) return;
  const sel1 = document.getElementById("jugador1_select");
  const sel2 = document.getElementById("jugador2_select");

  sel1.innerHTML = '';
  sel2.innerHTML = '';

  for(let j in jugadores_estado){
    if(jugadores_estado[j]!=="muerto" && j!=="HOST"){
      sel1.innerHTML += `<option value="${j}">${j}</option>`;
      sel2.innerHTML += `<option value="${j}">${j}</option>`;
    }
  }
}

function actualizarGrid(){
  const container = document.getElementById("jugadores_grid");
  container.innerHTML = "";

  for(let j in jugadores_estado){
    if(j==="HOST") continue;
    const estado = jugadores_estado[j];
    const div = document.createElement("div");
    div.className = "grid-item";

    const img = document.createElement("img");
    img.src = partidasFotos[j] || "/static/icon.png";
    img.classList.add("jugador-foto");

    if(estado==="activo"){ img.style.borderColor="green"; img.style.filter="none"; }
    else if(estado==="inactivo"){ img.style.borderColor="orange"; img.style.filter="none"; }
    else if(estado==="muerto"){ 
      img.style.borderColor="red"; 
      img.style.filter="grayscale(100%)"; 
      const skull = document.createElement("div"); 
      skull.className="calavera"; 
      div.appendChild(skull); 
    }

    div.appendChild(img);
    const span = document.createElement("span"); span.textContent=j; div.appendChild(span);

    if(es_host && estado!=="muerto"){
      const btn = document.createElement("button");
      btn.textContent="üíÄ Matar";
      btn.onclick = ()=>socket.emit("matar_jugador",{codigo,jugador:j});
      div.appendChild(btn);
    }

    container.appendChild(div);
  }
}

// -----------------------------------
// SOCKETS
// -----------------------------------
socket.on("jugadores",(data)=>{
  jugadores_estado=data.jugadores;
  partidasFotos=data.fotos;
  actualizarGrid();
  actualizarSelects();
});

// Hoguera y votaci√≥n
socket.on("votacion_iniciada",(data)=>{
  votacion = data;
  document.getElementById("hoguera_controls").style.display="block";
  actualizarVotos(votacion.votos);
  if(es_host) mostrarBotonesHost();
});

socket.on("votos_actualizados",(votos)=>{ actualizarVotos(votos); });
socket.on("votacion_finalizada",(votos)=>{
  actualizarVotos(votos);
  alert("Hoguera finalizada!\nResultado:\n" + votacion.jugadores[0] + ": " + votos[votacion.jugadores[0]] + "\n" + votacion.jugadores[1] + ": " + votos[votacion.jugadores[1]] + "\nNadie: " + votos["Nadie"]);
  document.getElementById("host_controls").innerHTML="";
  votacion=null;
});

// -----------------------------------
// Funciones Hoguera
// -----------------------------------
function actualizarVotos(votos){
  const div = document.getElementById("votos");
  if(votacion){
    div.innerHTML = votacion.jugadores.map(j=>j + ": " + votos[j]).join("<br>") + "<br>Nadie: " + votos["Nadie"];
  }
}

function mostrarBotonesHost(){
  const div = document.getElementById("host_controls");
  div.innerHTML = "";
  votacion.jugadores.forEach(j=>{
    const btnSum = document.createElement("button");
    btnSum.textContent = "+ " + j;
    btnSum.onclick = ()=>socket.emit("modificar_voto",{codigo, jugador:j, accion:"sumar", host:nombre});
    const btnRest = document.createElement("button");
    btnRest.textContent = "- " + j;
    btnRest.onclick = ()=>socket.emit("modificar_voto",{codigo, jugador:j, accion:"restar", host:nombre});
    div.appendChild(btnSum);
    div.appendChild(btnRest);
  });

  const btnNadie = document.createElement("button");
  btnNadie.textContent = "+ Nadie";
  btnNadie.onclick = ()=>socket.emit("modificar_voto",{codigo,jugador:"Nadie",accion:"sumar",host:nombre});
  div.appendChild(btnNadie);

  const btnFinal = document.createElement("button");
  btnFinal.textContent="Finalizar Hoguera";
  btnFinal.onclick = ()=>socket.emit("finalizar_hoguera",{codigo, host:nombre});
  div.appendChild(btnFinal);
}

// Iniciar hoguera y nueva partida host
if(es_host){
  document.getElementById("btn_iniciar_hoguera").onclick=()=>{
    const j1=document.getElementById("jugador1_select").value;
    const j2=document.getElementById("jugador2_select").value;
    if(j1===j2){ alert("Debes escoger dos jugadores distintos"); return; }
    socket.emit("iniciar_hoguera",{codigo, jugador1:j1, jugador2:j2, host:nombre});
  }

  document.getElementById("btn_nueva_partida").onclick = ()=>{
    socket.emit("nueva_partida",{codigo, host:nombre});
  }
}

// Status de jugador
if(!es_host){
  document.addEventListener("visibilitychange",()=>{socket.emit("set_status",{codigo,nombre,status:!document.hidden});});
  socket.emit("set_status",{codigo,nombre,status:true});
}
</script>
</body>
</html>
